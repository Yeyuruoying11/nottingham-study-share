# ğŸ”§ å¤´åƒæ›´æ–°åŒæ­¥é—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ› **é—®é¢˜æè¿°**

### é—®é¢˜ç°è±¡
- ç”¨æˆ·åœ¨è®¾ç½®é¡µé¢æ›´æ–°å¤´åƒåï¼Œå…¶ä»–é¡µé¢ï¼ˆä¸»é¡µã€ä¸ªäººèµ„æ–™ã€å¸–å­è¯¦æƒ…ç­‰ï¼‰çš„å¤´åƒæ˜¾ç¤ºä¸ä¼šå®æ—¶æ›´æ–°
- ä¸ªäººèµ„æ–™ä¿å­˜åï¼Œå¤–éƒ¨é¡µé¢ä¸ä¼šåŒæ­¥æ˜¾ç¤ºæœ€æ–°ä¿¡æ¯
- ç”¨æˆ·éœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°å¤´åƒå˜åŒ–

### é—®é¢˜æ ¹æº
1. **æ•°æ®æ¥æºä¸ä¸€è‡´**ï¼š
   - è®¾ç½®é¡µé¢å°†å¤´åƒä¿å­˜åˆ°Firestoreæ•°æ®åº“
   - å…¶ä»–é¡µé¢ä»åœ¨ä½¿ç”¨Firebase Authçš„`user.photoURL`ï¼ˆæ—§æ•°æ®ï¼‰
   
2. **ç¼ºå°‘åŒæ­¥æœºåˆ¶**ï¼š
   - æ²¡æœ‰å…¨å±€äº‹ä»¶é€šçŸ¥æœºåˆ¶
   - é¡µé¢é—´æ— æ³•å®æ—¶åŒæ­¥ç”¨æˆ·èµ„æ–™æ›´æ–°

## âœ… **è§£å†³æ–¹æ¡ˆ**

### 1. **å…¨å±€äº‹ä»¶æœºåˆ¶**

#### äº‹ä»¶ç±»å‹
- `userAvatarUpdated` - å¤´åƒæ›´æ–°äº‹ä»¶
- `userProfileUpdated` - å®Œæ•´ç”¨æˆ·èµ„æ–™æ›´æ–°äº‹ä»¶
- `usernameUpdated` - ç”¨æˆ·åæ›´æ–°äº‹ä»¶ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰

#### äº‹ä»¶æ•°æ®ç»“æ„
```javascript
// å¤´åƒæ›´æ–°äº‹ä»¶
{
  detail: {
    uid: string,
    newAvatarUrl: string
  }
}

// ç”¨æˆ·èµ„æ–™æ›´æ–°äº‹ä»¶
{
  detail: {
    uid: string,
    profile: {
      displayName: string,
      photoURL: string,
      university: string,
      year: string,
      bio: string
    }
  }
}
```

### 2. **æ•°æ®è·å–ç­–ç•¥**

#### ä¹‹å‰ï¼ˆæœ‰é—®é¢˜ï¼‰
```javascript
// ç›´æ¥ä½¿ç”¨Firebase Authæ•°æ®
src={user.photoURL}
```

#### ç°åœ¨ï¼ˆå·²ä¿®å¤ï¼‰
```javascript
// ä»Firestoreè·å–æœ€æ–°æ•°æ®
const [firestoreUserAvatar, setFirestoreUserAvatar] = useState('');

// è·å–ç”¨æˆ·èµ„æ–™
const fetchUserProfile = async () => {
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if (userDoc.exists()) {
    const userData = userDoc.data();
    setFirestoreUserAvatar(userData.photoURL || user.photoURL);
  }
};
```

### 3. **ä¿®æ”¹çš„é¡µé¢**

#### è®¾ç½®é¡µé¢ (`app/settings/page.tsx`)
- âœ… å¤´åƒé€‰æ‹©æ—¶è§¦å‘`userAvatarUpdated`äº‹ä»¶
- âœ… èµ„æ–™ä¿å­˜æ—¶è§¦å‘`userProfileUpdated`äº‹ä»¶
- âœ… åŒæ—¶æ”¯æŒStorageäº‹ä»¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ

#### ä¸»é¡µ (`app/page.tsx`)
- âœ… æ·»åŠ `firestoreUserAvatar`çŠ¶æ€ç®¡ç†
- âœ… ç›‘å¬å¤´åƒå’Œèµ„æ–™æ›´æ–°äº‹ä»¶
- âœ… ç”¨æˆ·å¤´åƒæ˜¾ç¤ºä½¿ç”¨Firestoreæ•°æ®

#### ä¸ªäººèµ„æ–™é¡µ (`app/profile/page.tsx`)
- âœ… ç›‘å¬ç”¨æˆ·èµ„æ–™æ›´æ–°äº‹ä»¶
- âœ… å®æ—¶æ›´æ–°å¤´åƒå’Œç”¨æˆ·åæ˜¾ç¤º

#### åˆ›å»ºå¸–å­é¡µ (`app/create/page.tsx`)
- âœ… è·å–Firestoreç”¨æˆ·å¤´åƒ
- âœ… å‘å¸ƒå¸–å­æ—¶ä½¿ç”¨æœ€æ–°å¤´åƒ

#### å¸–å­è¯¦æƒ…é¡µ (`app/post/[id]/page.tsx`)
- âœ… æ·»åŠ ç”¨æˆ·å¤´åƒçŠ¶æ€ç®¡ç†
- âœ… è¯„è®ºæ—¶ä½¿ç”¨æœ€æ–°å¤´åƒ
- âœ… ç›‘å¬å¤´åƒæ›´æ–°äº‹ä»¶

## ğŸš€ **ä½¿ç”¨è¯´æ˜**

### å¯¹ç”¨æˆ·çš„æ”¹è¿›
1. **å³æ—¶æ›´æ–°**ï¼šå¤´åƒé€‰æ‹©åç«‹å³åœ¨æ‰€æœ‰é¡µé¢ç”Ÿæ•ˆ
2. **ä¿å­˜æœºåˆ¶**ï¼šç”¨æˆ·ä¿®æ”¹èµ„æ–™åéœ€ç‚¹å‡»"ä¿å­˜"æŒ‰é’®æ‰ç”Ÿæ•ˆ
3. **å…¨å±€åŒæ­¥**ï¼šæ‰€æœ‰é¡µé¢çš„ç”¨æˆ·å¤´åƒå’Œä¿¡æ¯ä¿æŒä¸€è‡´

### å¯¹å¼€å‘è€…çš„æ”¹è¿›
1. **ç»Ÿä¸€æ•°æ®æº**ï¼šæ‰€æœ‰é¡µé¢éƒ½ä»Firestoreè·å–æœ€æ–°ç”¨æˆ·èµ„æ–™
2. **äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡å…¨å±€äº‹ä»¶å®ç°é¡µé¢é—´æ•°æ®åŒæ­¥
3. **å‘åå…¼å®¹**ï¼šä¿ç•™åŸæœ‰çš„usernameæ›´æ–°äº‹ä»¶

## ğŸ”„ **äº‹ä»¶æµç¨‹**

```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©å¤´åƒ] --> B[è®¾ç½®é¡µé¢æ›´æ–°çŠ¶æ€]
    B --> C[ä¿å­˜åˆ°Firestore]
    C --> D[è§¦å‘userAvatarUpdatedäº‹ä»¶]
    D --> E[ä¸»é¡µç›‘å¬äº‹ä»¶]
    D --> F[ä¸ªäººèµ„æ–™é¡µç›‘å¬äº‹ä»¶]
    D --> G[å…¶ä»–é¡µé¢ç›‘å¬äº‹ä»¶]
    E --> H[æ›´æ–°ä¸»é¡µå¤´åƒæ˜¾ç¤º]
    F --> I[æ›´æ–°ä¸ªäººèµ„æ–™å¤´åƒ]
    G --> J[æ›´æ–°å…¶ä»–é¡µé¢å¤´åƒ]
```

## ğŸ›  **æŠ€æœ¯ç»†èŠ‚**

### äº‹ä»¶è§¦å‘
```javascript
// è®¾ç½®é¡µé¢ - å¤´åƒæ›´æ–°
window.dispatchEvent(new CustomEvent('userAvatarUpdated', {
  detail: { 
    uid: user.uid,
    newAvatarUrl: avatarUrl 
  }
}));
```

### äº‹ä»¶ç›‘å¬
```javascript
// å…¶ä»–é¡µé¢ - ç›‘å¬å¤´åƒæ›´æ–°
const handleAvatarUpdate = (event: CustomEvent) => {
  if (event.detail.uid === user?.uid) {
    setFirestoreUserAvatar(event.detail.newAvatarUrl);
  }
};

window.addEventListener('userAvatarUpdated', handleAvatarUpdate);
```

### å¤‡ç”¨æœºåˆ¶
```javascript
// Storageäº‹ä»¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
const event = new StorageEvent('storage', {
  key: 'userAvatarUpdate',
  newValue: JSON.stringify({ uid: user.uid, photoURL: avatarUrl }),
  oldValue: null
});
window.dispatchEvent(event);
```

## âœ¨ **æµ‹è¯•éªŒè¯**

### æµ‹è¯•æ­¥éª¤
1. ç™»å½•ç”¨æˆ·è´¦å·
2. è¿›å…¥è®¾ç½®é¡µé¢ (`/settings`)
3. ç‚¹å‡»å¤´åƒæ—çš„ç›¸æœºå›¾æ ‡
4. é€‰æ‹©æ€§åˆ«å¹¶é€‰æ‹©æ–°å¤´åƒ
5. ç‚¹å‡»"ç¡®è®¤é€‰æ‹©"
6. æ£€æŸ¥ä¸»é¡µå³ä¸Šè§’ç”¨æˆ·å¤´åƒæ˜¯å¦ç«‹å³æ›´æ–°
7. è®¿é—®ä¸ªäººèµ„æ–™é¡µé¢ï¼Œç¡®è®¤å¤´åƒå·²æ›´æ–°
8. å‘å¸ƒæ–°å¸–å­ï¼Œç¡®è®¤ä½¿ç”¨æ–°å¤´åƒ

### é¢„æœŸç»“æœ
- âœ… å¤´åƒé€‰æ‹©åç«‹å³åœ¨æ‰€æœ‰é¡µé¢ç”Ÿæ•ˆ
- âœ… æ— éœ€åˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°å˜åŒ–
- âœ… æ–°å‘å¸ƒçš„å¸–å­ä½¿ç”¨æœ€æ–°å¤´åƒ
- âœ… è¯„è®ºæ—¶æ˜¾ç¤ºæœ€æ–°å¤´åƒ

## ğŸ“ **æ³¨æ„äº‹é¡¹**

1. **é”™è¯¯å¤„ç†**ï¼šå¦‚æœFirestoreè·å–å¤±è´¥ï¼Œä¼šé™çº§ä½¿ç”¨Firebase Authæ•°æ®
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šåªæœ‰ç›¸å…³ç”¨æˆ·çš„äº‹ä»¶æ‰ä¼šè§¦å‘æ›´æ–°
3. **å…¼å®¹æ€§**ï¼šä¿ç•™äº†åŸæœ‰çš„usernameæ›´æ–°æœºåˆ¶
4. **ç±»å‹å®‰å…¨**ï¼šä¿®å¤äº†isAdminç±»å‹é—®é¢˜

## ğŸ¯ **æ€»ç»“**

é€šè¿‡å®ç°å…¨å±€äº‹ä»¶æœºåˆ¶å’Œç»Ÿä¸€æ•°æ®æºç­–ç•¥ï¼Œå½»åº•è§£å†³äº†ç”¨æˆ·å¤´åƒæ›´æ–°åå¤–éƒ¨ä¸å˜åŒ–çš„é—®é¢˜ã€‚ç°åœ¨ç”¨æˆ·ä½“éªŒæ›´åŠ æµç•…ï¼Œå¼€å‘ç»´æŠ¤ä¹Ÿæ›´åŠ ç®€å•ã€‚ 